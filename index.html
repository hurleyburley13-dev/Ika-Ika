<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PhishBait — Spot phishing emails (Alarm Monitoring)</title>
<style>
:root{--bg:#070707;--panel:#0e0e0e;--muted:#a3a3a3;--text:#f3f3f3;--accent:#ff2d2d;--accent-2:#b30000;--good:#22c55e;--bad:#ff3b30;--border:#1e1e1e}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:#060606}
.container{max-width:1100px;margin:24px auto;padding:18px}
.panel{background:linear-gradient(180deg,#0f0f0f,#070707);border:1px solid var(--border);border-radius:12px;padding:12px}
#titleCard{display:grid;gap:14px;justify-items:center;padding:28px 22px;border-radius:12px}
#titleLogo{height:80px}
.gameTitle{font-size:28px;margin:0}
.setupRow{display:grid;grid-template-columns:1fr 180px 120px;gap:10px;width:100%;max-width:720px}
input,select,button{padding:10px;border-radius:10px;border:1px solid #222;background:#0b0b0b;color:var(--text)}
button{cursor:pointer}
.header{display:flex;justify-content:space-between;align-items:center;margin:12px 0}
.hud{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:10px;border-radius:8px;background:#0b0b0b;margin-bottom:8px}
.stat{background:#0b0b0b;padding:8px;border-radius:8px;border:1px solid var(--border)}
.label{color:var(--muted);font-size:12px}
.value{font-weight:700}
.progress{height:10px;background:#0b0b0b;border-radius:8px;overflow:hidden}
.bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#ff6b6b)}
.split{display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media (max-width:900px){.split{grid-template-columns:1fr}}
.email-top{display:flex;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
.avatar{width:44px;height:44px;border-radius:50%;background:#111;display:grid;place-items:center;font-weight:800}
.subject{font-size:18px;font-weight:700}
.meta{color:#c9c9c9;font-size:13px}
.email-header{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px;border-bottom:1px dashed var(--border);background:#090909}
.email-body{padding:16px;line-height:1.6}
a{color:#ff6b6b; text-decoration:underline}
.actions{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:#0a0a0a;border-radius:0 0 12px 12px}
.btn{padding:10px 12px;border-radius:8px;border:1px solid #2a2a2a;background:#121212;color:var(--text);cursor:pointer}
.btn.bad{background:#2b0808}
.btn.good{background:#082b12}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.hist{max-height:420px;overflow:auto}
.hist-item{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px dashed var(--border)}
.chip{background:#0b0b0b;padding:6px 8px;border-radius:999px;border:1px solid var(--border)}
.tooltip{position:fixed;pointer-events:none;background:#0b0b0b;border:1px solid #3a0f0f;padding:6px 8px;border-radius:6px;font-size:12px;color:#f0cccc;box-shadow:0 6px 24px rgba(0,0,0,.45);z-index:1000;opacity:0;transform:translateY(6px);transition:opacity .08s,transform .08s}
.tooltip.show{opacity:1;transform:translateY(0)}
.explain{margin:12px;padding:10px;border-radius:8px;background:#0b0b0b;border:1px solid var(--border)}
.explain h4{margin:6px 0}
.outline-good{outline:2px solid var(--good) !important}
.outline-bad{outline:2px solid var(--bad) !important}
#resultBanner{display:none;padding:10px;border-radius:8px;margin-bottom:8px;font-weight:700}
#completionPanel{display:none;padding:16px;border-radius:10px;background:linear-gradient(180deg,#0f0f0f,#070707);border:1px solid var(--border);margin-top:12px}
</style>
</head>
<body>
  <div class="container">
    <section id="titleScreen" class="panel">
      <div id="titleCard">
        <img id="titleLogo" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='80'><rect width='100%' height='100%' fill='%23b30000'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='36' fill='white'>AW</text></svg>" alt="Alarm Watch logo">
        <h1 class="gameTitle"><span style="color:var(--accent)">PhishBait</span> — Spot Phishing Emails<br><span style="font-size:14px;color:#c9c9c9">Alarm Monitoring Edition</span></h1>
        <div class="setupRow">
          <input id="nameInput" type="text" placeholder="Enter your name" aria-label="Player name">
          <select id="levelSelect" aria-label="Difficulty level">
            <option>Beginner</option>
            <option>Intermediate</option>
            <option>Expert</option>
          </select>
          <button id="startBtn" class="btn">Start</button>
        </div>
        <div style="width:100%;max-width:720px;margin-top:10px">
          <h3 style="margin:0 0 8px 0">High scores</h3>
          <table id="scoreTable" style="width:100%;border-collapse:collapse"><thead>
  <tr style="color:#c9c9c9">
    <th style="text-align:left">#</th>
    <th style="text-align:left">Player</th>
    <th style="text-align:left">Score</th>
    <th style="text-align:left">Difficulty</th>
  </tr>
</thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <div id="gamePanel" class="panel" style="display:none;margin-top:12px">
      <header class="header">
        <div class="brand"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='36'><rect width='100%' height='100%' fill='%23b30000'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='18' fill='white'>AW</text></svg>" alt="logo" style="height:36px"><div class="badge">PhishBait</div></div>
        <div id="playerInfo" class="chip">No player</div>
      </header>

      <div class="hud" role="status">
        <div class="stat"><div class="label">Player</div><div class="value" id="hudPlayer">—</div></div>
        <div class="stat"><div class="label">Score</div><div class="value" id="hudScore">0</div></div>
        <div class="stat"><div class="label">Correct</div><div class="value" id="hudCorrect">0</div></div>
        <div class="stat"><div class="label">Wrong</div><div class="value" id="hudWrong">0</div></div>
      </div>
      <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>

      <div class="split" style="margin-top:12px">
        <main>
          <section class="panel" style="padding:0">
            <div class="email-top">
              <div class="avatar" id="fromAvatar">AW</div>
              <div>
                <div class="subject" id="emailSubjectTop">—</div>
                <div class="meta" id="emailMetaLine">From — • To you • <span id="emailTimeTop">—</span></div>
              </div>
            </div>
            <div class="email-header">
              <div><strong>From</strong><div id="emailFrom">—</div></div>
              <div><strong>Subject</strong><div id="emailSubject">—</div></div>
              <div><strong>Received</strong><div id="emailReceived">—</div></div>
              <div><strong>Level</strong><div id="emailLevel">—</div></div>
            </div>
            <div id="emailBackground" class="explain" style="margin:12px 16px;padding:10px;border-radius:8px;background:#0b0b0b;border:1px solid var(--border);"><strong>Background</strong><div id="emailBackgroundText" style="margin-top:6px;color:#dcdcdc">—</div></div>
            <div id="emailBody" class="email-body">—</div>

            <div id="resultBanner" role="status"></div>

            <div id="explainBox" class="explain" hidden>
              <h4 id="explainCorrectHeading">Why is this correct?</h4>
              <ul id="explainCorrectList" style="margin:0;padding-left:18px;color:#e8e8e8"></ul>
              <h4 id="explainPhishHeading">Why is this phishing?</h4>
              <ul id="explainPhishList" style="margin:0;padding-left:18px;color:#e8e8e8"></ul>
            </div>

            <div class="actions">
              <button id="btnPhish" class="btn bad">PHISH</button>
              <button id="btnSafe" class="btn good">SAFE</button>
              <div style="flex:1"></div>
              <button id="btnPrev" class="btn" disabled>Previous</button>
              <button id="btnNext" class="btn" disabled>Next</button>
              <button id="btnReset" class="btn">Reset</button>
            </div>
          </section>
        </main>
        <aside>
          <div class="card" style="padding:12px;margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="chip">High score: <strong id="highScore">0</strong></div>
              <div class="chip">Round <span id="roundPos">0</span>/10</div>
            </div>
          </div>
          <div class="card">
            <div class="chip" style="margin-bottom:8px">History</div>
            <div id="history" class="hist"></div>
          </div>
        </aside>
      </div>
    </div>

    <div id="completionPanel" class="panel">
      <div id="completionSummary" style="font-weight:700;margin-bottom:8px">—</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnTrySame" class="btn">Try this difficulty again</button>
        <button id="btnTryDifferent" class="btn">Try a different difficulty</button>
        <div style="flex:1"></div>
        <button id="btnBackToTitle" class="btn">Back to main menu</button>
      </div>
    </div>

    <footer style="margin-top:12px;color:var(--muted);font-size:12px">Black & Red theme • Links never navigate</footer>
  </div>

  <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

<script>
/* --- dataset --- */
const DATA = {
  Beginner:[
    {id:'b1',level:'Beginner',from:'Dispatch <dispatch@monitoringstation.co.nz>',subject:'Test alarm: Setting up new Permaconn device',received:'2025-09-18 07:14',phish:false,background: 'Known sender — you commonly receive messages like this from this address or vendor.',body:'Hi team, just finished setting up a permaconn at this site, here are the sites details.<br><br>View event in portal: <a href="#" data-href="https://portal.monitoringstation.co.nz/events/4821">portal.monitoringstation.co.nz/events/4821</a>',explain:['Legitimate internal sender and domain','Event link goes to the official portal domain']},
    {id:'b2',level:'Beginner',from:'TELCO Billing <billing@telc0.nz>',subject:'Invoice overdue - pay now',received:'2025-09-16 16:02',phish:true,background: 'You have never had correspondence with this email address; unexpected requests here are suspicious.',body:'Your August invoice is overdue. Pay immediately or services will be ceased: <a href="#" data-href="http://pay.telc0.nz-login.com">pay portal</a>',explain:['Lookalike domain telc0 (zero)']},
    {id:'b3',level:'Beginner',from:'Rostering <shifts@monitoringstation.co.nz>',subject:'Shift swap request - Friday night',received:'2025-09-12 09:21',phish:false,background: 'Known sender — you commonly receive messages like this from this address or vendor.',body:'Can anyone cover Friday 22:00-06:00? Time and a half on offer: <a href="#" data-href="https://monitoringstation.co.nz/rostering">Rostering</a>',explain:['Internal rostering address','HTTPS link']},
    {id:'b4',level:'Beginner',from:'Alarm Cloud <no-reply@alarmcloud.support>',subject:'New voicemail from Downer Intercom',received:'2025-09-10 13:17',phish:true,background: 'You have never had correspondence with this email address; unexpected requests here are suspicious.',body:'Voice message (28s). Download MP3: <a href="#" data-href="https://alarmcloud.support.voicemail.gq/file.mp3">alarmcloud voicemail</a>',explain:['Unexpected MP3 download']},
    {id:'b5',level:'Beginner',from:'Accounts Payable <ap@monitoringstation.co.nz>',subject:'September supplier remittance',received:'2025-09-09 08:02',phish:false,background: 'Known sender — you commonly receive messages like this from this address or vendor.',body:'Attached is the September remittance. Vendor list visible at <a href="#" data-href="https://portal.monitoringstation.co.nz/vendors">vendor portal</a>.',explain:['Normal AP message content','Official portal host']},
    {id:'b6',level:'Beginner',from:'Microsoft MFA <no-reply@m1crosoft.com>',subject:'Reset your authenticator now',received:'2025-09-07 18:45',phish:true,background: 'You have never had correspondence with this email address; unexpected requests here are suspicious.',body:'We detected suspicious activity. New Zeland Computer Solutions team member Grog, has requested you Re-enrol here: <a href="#" data-href="https://secure-microsoft.com.re-enrol.id/">https://secure-microsoft.com…</a>',explain:['Misspelled m1crosoft in sender']},
    { id:'b7', level:'Beginner',
  from:'Courier NZ <no-reply@couriers.co.nz>',
  subject:'Delivery ETA for Monitoring Station',
  received:'2025-09-04 10:01',
  phish:false,
  background: 'Known sender — you commonly receive messages like this from this address or vendor.',body:'Delivery ETA today. Track at <a href="#" data-href="https://couriers.co.nz/track/ABC123">couriers.co.nz/track/ABC123</a>',
  explain:[
    'Official courier domain with HTTPS tracking page',
    'The message matches a recent consignment number in our system (expected)',
    'No urgent payment or credential requests — just tracking information'
  ]
},
    {id:'b8',level:'Beginner',from:'IT Support <support@monitoring-station.com>',subject:'Password expiry in 1 day',received:'2025-09-03 07:59',phish:true,background: 'You have never had correspondence with this email address; unexpected requests here are suspicious.',body:'Reset here: <a href="#" data-href="http://monitoring-station.com.it-service-reset.com">Password Center</a>',explain:['Hyphenated lookalike sending domain not our primary','Reset link goes to unrelated domain']},
    { id:'b9', level:'Beginner',
  from:'Ajax Systems <invoices@ajax.com>',
  subject:'Invoice INV-2025-472 issued',
  received:'2025-09-02 15:31',
  phish:false,
  background: 'Known sender — you commonly receive messages like this from this address or vendor.',body:'Hello Team </p>\n<p>, Invoice available in supplier portal <a href="#" data-href="https://partners.ajax.com/login">partners.ajaxcom/login</a> <br> Thanks for your continued support',
  explain:[
    'Well-known vendor domain (ajax.com) and HTTPS portal',
    'We have an existing purchase order relationship on file (expected invoice)',
    'No request for credentials in the email body — it directs to a vendor portal login only'
  ]
},
    {id:'b10',level:'Beginner',from:'Security Team <soc@monitoringstation.co.nz>',subject:'SEV-2 false alarm pattern addressed',received:'2025-08-29 11:12',phish:false,background: 'Known sender — you commonly receive messages like this from this address or vendor.',body:'We moved where the cameras are looking for two sites. Change log: <a href="#" data-href="https://monitoringstation.co.nz/changelog">changelog</a>',explain:['Internal SOC sender','Link over HTTPS']}
  ],
  Intermediate:[{id:'i1',level:'Intermediate',from:'Security Team <soc@monitoringstation.co.nz>',subject:'Unusual login to portal (info only)',received:'2025-09-20 06:31',phish:false,body:'\n<p>Hi </p>\n<p>We noticed an unusual login to the portal for your account this morning at 06:28 from an IP that geolocates to Hamilton. This is an informational message only — our automated systems flagged it because it was from a new device.</p>\n<p>If this was you, no action is required. If you didn’t sign in, please open an IT support ticket so we can investigate further and lock the session while we confirm the activity. You can view the event details and recent sessions in the IT portal here: <a href="#" data-href="https://monitoringstation.co.nz/it-support/sessions/<?=$RND?>">View session details</a>.</p>\n<p>Regards,<br>Security Operations</p>\n',explain:['Uses our official @monitoringstation.co.nz domain','No direct “reset password now” link; directs to internal IT page']},
{id:'i2',level:'Intermediate',from:'Parking <parking@aucklandairport.co.nz>',subject:'Receipt: Staff parking top-up',received:'2025-09-18 09:17',phish:false,background: 'Expected external message — this sender or service is one you have interacted with before.',body:'\n<p>Hello,</p>\n<p>Thanks for topping up the staff parking account — the payment was processed successfully and your receipt is attached to your airport account. This email confirms the $45 top-up for parking permit #425 and includes the transaction reference.</p>\n<p>If you think this transaction is incorrect, please reply to this email within 7 days so we can review the charge and reverse it where required. To view the receipt and manage your parking permits please log in to your airport account: <a href="#" data-href="https://my.aucklandairport.co.nz/receipts/REF-8421">View receipt</a>.</p>\n<p>Kind regards,<br>Parking Services – Auckland Airport</p>\n',explain:['Recognisable sender and domain','No request for credentials by email']},
{id:'i3',level:'Intermediate',from:'Microsoft 365 <no-reply@micros0ft-security.com>',subject:'NZSC has requested you Verify your account ownership',received:'2025-09-15 20:13',phish:true,body:'\n<p>Hi team,</p>\n<p>We require a quick verification of account ownership for NZSC’s Microsoft tenant — routine security checks are being applied this week across admin accounts. Please follow the link below to confirm your details so we can complete the verification. This helps us prevent accidental lockouts during the next policy roll-out.</p>\n<p><strong>Important:</strong> this process will only take a minute and will redirect you to the verification portal to confirm your email and device enrolment: <a href="#" data-href="https://protection.micros0ft-security.com/verify">Verify account</a>.</p>\n<p>Thanks for your prompt attention,<br>IT Security (automated)</p>\n',explain:['micros0ft uses a zero (0) in the domain','Not an official Microsoft domain']},
{ id:'i4', level:'Intermediate',
  from:'Xero Notifications <notifications@xero.com>',
  subject:'August reconciliation complete',
  received:'2025-09-14 12:03',
  phish:false,
  background: 'Known sender — you commonly receive messages like this from this address or vendor.',body:'\n<p>Hi Accounts,</p>\n<p>The August reconciliation has completed successfully for our primary account. I’ve attached the summary and flagged one supplier with a small variance for review — see line 47 in the reconciliation report for details.</p>\n<p>Please open Xero to review the full report and mark items as reviewed: <a href="#" data-href="https://login.xero.com/Reports/Reconciliation/12345">Open reconciliation</a>. If you want me to pull a filtered export for the vendor variance I can do that and add notes to the ledger.</p>\n<p>Best regards,<br>Oliver Chen<br>Accounts Payable</p>\n',
  explain:[
    'Official SaaS login domain (login.xero.com) over HTTPS',
    'Automated notification matching our finance workflow (expected monthly recon)',
    'No password request in the email — link goes to the legitimate login interface'
  ]
},
{id:'i5',level:'Intermediate',from:'Courier Update <notify@nzpost.co.nz>',subject:'Re-delivery fee required',received:'2025-09-13 09:11',phish:true,body:'\n<p>Dear recipient,</p>\n<p>We attempted delivery of a parcel addressed to the Monitoring Station this morning but there was no one to accept it. The courier has placed a temporary hold and requests payment of a small re-delivery fee to schedule a second attempt.</p>\n<p>If you are expecting a delivery, please review the re-delivery details and pay the fee to avoid return to sender: <a href="#" data-href="http://nzpost.co.nz.redelivery-fee.com/track/ABC123">Pay re-delivery fee</a>. If this delivery is unexpected, please ignore this email.</p>\n<p>Regards,<br>NZ Post – Delivery Services</p>\n',explain:['Link goes to unrelated domain with nzpost inside','Uses insecure http://']},
{id:'i6',level:'Intermediate',from:'HR <people@monitoringstation.co.nz>',subject:'Updated leave policy',received:'2025-09-11 08:00',phish:false,background: 'Known sender — you commonly receive messages like this from this address or vendor.',body:'\n<p>Hi everyone,</p>\n<p>We’ve published an update to the leave policy effective from next pay period. The main change affects unpaid leave approvals and the notice period required for extended leave.</p>\n<p>Please read the full policy and acknowledge the update in the HR portal: <a href="#" data-href="https://monitoringstation.co.nz/policies/leave">Read updated leave policy</a>. If you have any questions, drop them into the HR channel or email people@monitoringstation.co.nz.</p>\n<p>Thanks,<br>People & Culture</p>\n',explain:['Official domain and link','Normal internal comms tone']},
{id:'i7',level:'Intermediate',from:'IT Service Desk <support@monitoringstation.co.nz>',subject:'Device enrollment reminder',received:'2025-09-10 10:22',phish:false,body:'\n<p>Hi </p>\n<p>This is a reminder to complete device enrollment for corporate mobile management. Enrollment ensures your device receives security updates and can access internal resources. The deadline is this Friday; devices not enrolled may lose access to email and intranet services.</p>\n<p>Full instructions and the enrollment wizard are available in the message service: <a href="#" data-href="https://monitoringstation.co.nz/it/enrol">Complete device enrollment</a>. If you need assistance during enrolment, reply and the technology manager will help remotely.</p>\n<p>Cheers,<br>Technology Manager</p>\n',explain:['Internal sender','No external website used']},
{id:'i8',level:'Intermediate',from:'Voicemail <no-reply@vmail-monstation.gq>',subject:'Voice message (47s)',received:'2025-09-09 07:45',phish:true,background: 'You have never had correspondence with this email address; unexpected requests here are suspicious.',body:'\n<p>Hi,</p>\n<p>You have a new voicemail. Click the link to listen to the message — the message length is 47 seconds and it was recorded at 07:42 this morning. The voicemail reference is VM-91822.</p>\n<p>Listen online: <a href="#" data-href="https://vmail-monstation.gq/file.mp3">Listen to voicemail</a>. If you are unable to play audio in your browser, download the MP3 to a trusted device first.</p>\n<p>Regards,<br>Voicemail Service</p>\n',explain:['Uncommon .gq TLD','Unexpected audio download']},
{ id:'i9', level:'Intermediate',
  from:'Supply Chain <orders@atlasgentech.co.nz>',
  subject:'Order shipped: Site 3012 - 4x dome cams',
  received:'2025-09-07 13:18',
  phish:false,body:'\n<p>Hello,</p>\n<p>Your order for four dome cameras to Site 3012 has shipped. The shipment includes the units and mounting kits; the expected delivery date is two business days from dispatch. The purchase order and tracking number are referenced below.</p>\n<p>To view the order and detailed tracking information please go to the supplier portal: <a href="#" data-href="https://portal.atlasgentech.co.nz/suppliers/orders/3012">View order 3012</a>. If anything looks incorrect, reply to this message and we’ll coordinate with dispatch.</p>\n<p>Regards,<br>Supply Chain – Atlas Gentech</p>\n',
  explain:[
    'Known contractor with prior purchase history',
    'The URL host matches the contractor portal and uses HTTPS',
    'Message references a PO and shipment that matches our system (expected)'
  ]
},
{id:'i10',level:'Intermediate',from:'IT Admin <it-admin@monitoring--station.co.nz>',subject:'VPN certificate expired - update now',received:'2025-09-05 19:31',phish:true,background: 'You have never had correspondence with this email address; unexpected requests here are suspicious.',body:'\n<p>Hi </p>\n<p>Our monitoring VPN certificate recently expired on one of our appliances. To restore connectivity you\\\'ll need to download and install a new certificate. The certificate file is provided below and must be installed on the VPN gateway.</p>\n<p>Download certificate: <a href="#" data-href="http://vpn.monitoring--station.co.nz.update-now.info/cert.crt">Download cert</a>. If you are not the network admin, please escalate immediately to the networking team.</p>\n<p>Thanks,<br>IT Network</p>\n',explain:['Hyphenated fake company domain in sender','Download link is not our domain and uses http://']}],
  Expert:[
    {id:'e1',level:'Expert',from:'Security Alerts <alerts@monitoringstation.co.nz>',subject:'Failed SMS (report)',received:'2025-09-22 04:50',phish:false,body:'\n<p>Team,</p>\n<p>During overnight processing we observed several inbound messages that failed alignment and were rejected by our perimeter. I’ve posted a summary report with affected senders and message IDs to the security for review.</p>\n<p>Read the report and the recommended remediation steps here: <a href="#" data-href="https://monitoringstation.co.nz/security/SMS">SMS failure report</a>. If you own any of the listed sender domains, please coordinate with the mailops team to update the DNS records.</p>\n<p>Regards,<br>Mail Operations</p>\n',explain:['Internal alerts address','Points to report, not to an external action link']},
    {id:'e2',level:'Expert',from:'Microsoft Teams <no-reply@microsoft.com>',subject:'You have 2 missed messages',received:'2025-09-21 21:08',phish:false,background: 'No background on Expert questions',body:'\n<p>Hi </p>\n<p>You have two missed messages in Microsoft Teams from this afternoon. They were left in channels you follow and include a short action item for the Environment project.</p>\n<p>Open Teams to view and respond: <a href="#" data-href="https://teams.microsoft.com/l/message/19:abc123">Open Teams</a>.</p>\n<p>Thanks,<br>Notifications Service</p>\n',explain:['Official microsoft.com domain']},
    {id:'e3',level:'Expert',from:'ServiceNow <no-reply@servicenow-support.co.ru>',subject:'Ticket requires your password',received:'2025-09-20 15:42',phish:true,background: 'No background on Expert questions',body:'\n<p>Hello,</p>\n<p>Ticket #INC-4721 has been created and requires confirmation. For security reasons we need owners to re-enter a credential to view the full ticket details and attached logs. If you are the ticket owner, confirm via the link below to decrypt the attachment.</p>\n<p>Confirm ownership: <a href="#" data-href="https://servicenow-support.co.ru/login">Confirm and view ticket</a>. Note that ServiceNow does not ask for passwords in ticket notifications; if a credential is requested by email you should contact the service desk directly.</p>\n<p>Regards,<br>Service Desk</p>\n',explain:['Not an official servicenow domain (.co lookalike)','Requests your password via email link, which is a red flag']},
    {id:'e4',level:'Expert',from:'CEO <ceo@monitoringstation.co.nz>',subject:'All staff: emergency gift card purchase',received:'2025-09-19 07:23',phish:false,background: 'No background on Expert questions.',body:'\n<p>All staff,</p>\n<p>To celebrate our quarterly targets the executive team has approved a small gift for staff. Please purchase gift cards on behalf of the team using this dedicated procurement page and retain receipts for reimbursement.</p>\n<p> You all know I buy the gift cards myself, anyone who fell for this email will have a meeting with me.: <a href="#" data-href="https://monitoringstation.co.nz/finance/giftcards">Procurement page</a>.</p>\n<p>Kind regards,<br>Executive Office</p>\n',explain:['Educational: real-life CEO fraud often spoofs addresses; in the game, trust @monitoringstation.co.nz but still apply caution in real life']},
    {id:'e5',level:'Expert',from:'Service Desk <support@monitor1ngstation.co.nz>',subject:'Urgent: MFA disabled',received:'2025-09-18 18:01',phish:true,background: 'No background on Expert questions',body:'\n<p>Hi,</p>\n<p>We detected that multi-factor authentication for your account was disabled. To re-enable MFA please visit the self-service portal and confirm your identity. This is an automated alert — if you did not perform this action, please contact IT immediately.</p>\n<p>Re-enable MFA: <a href="#" data-href="https://mfa.monitor1ngstation.co.nz-recover.net">Re-enable MFA</a>. Note: official alerts will link to our corporate domain and not to third-party recovery hosts.</p>\n<p>Regards,<br>Identity Services</p>\n',explain:['monitor1ngstation swaps the “i” for a “1”','Link goes to unrelated domain with our name inside']},
    { id:'e6', level:'Expert',
  from:'Hikvision Billing <billing@hikvision.com>',
  subject:'Credit note CN-22014',
  received:'2025-09-16 11:05',
  phish:false,
  background: 'No background on Expert questions',body:'\n<p>Hi Accounts,</p>\n<p>We’ve issued a credit note CN-22014 for the returned goods. The credit is applied to your account and the full details are available in the Hikvision supplier portal. This credit offsets the recent RMA on device serials 98-104.</p>\n<p>View credit note: <a href="#" data-href="https://portal.hikvision.com/credit-notes/22014">View CN-22014</a>. If you need the PDF for accounting uploads, let me know and I will attach it directly.</p>\n<p>Regards,<br>Hikvision Billing</p>\n',
  explain:[
    'Manufacturer domain (hikvision.com) with HTTPS link',
    'Email is part of an expected credit-note workflow (recent return processed)',
    'In production we also validate DKIM/SPF for such senders — signed messages increase trust'
  ]
},
    {id:'e7',level:'Expert',from:'Microsoft <no-reply@microsoft.com>',subject:'Security notification',received:'2025-09-15 06:59',phish:true,background: 'No background on Expert questions',body:'\n<p>Hi </p>\n<p>We detected a security issue with your Microsoft account and require you to run a quick security check. Please follow the link to review blocked sign-in attempts and confirm your device list.</p>\n<p>Review activity: <a href="#" data-href="https://microsoft.com.security-check.app">Review sign-in</a>. Reminder: official Microsoft notices will use microsoftonline or accounts.google domains for sign-in links — anything else should be treated cautiously.</p>\n<p>Security Team</p>\n',explain:['The visible text includes microsoft.com but the true host is security-check.app (mismatch)']},
    {id:'e8',level:'Expert',from:'Eyespy <no-reply@eyespy.co.nz>',subject:'Panel offline at Site 3012',received:'2025-09-13 03:59',phish:false,background: 'No background on Expert questions',body:'\n<p>Operations,</p>\n<p>We observed the Cameral at Site 3012 reporting offline at 03:24. The panel reconnected at 03:40 after a scheduled firmware update. Please check the attached status log for a timeline and confirm whether on-site Cmaintenance is required.</p>\n<p>See the status page for details: <a href="#" data-href="https://eyespy.co.nz/incident/3012">Panel status</a>.</p>\n<p>Regards,<br>Remote Monitoring</p>\n',explain:['Known manufacturer domain']},
    {id:'e9',level:'Expert',from:'Payroll <payroll@monitoringstation.co.nz>',subject:'Payslip available',received:'2025-09-12 08:05',phish:false,background: 'No background on Expert questions',body:'\n<p>Hi </p>\n<p>Your most recent payslip is available for review on the payroll intranet. This includes the month’s ordinary earnings, holiday accruals and the tax summary. Please review and let payroll know of any discrepancies within 5 working days.</p>\n<p>Open payslip: <a href="#" data-href="https://monitoringstation.co.nz/payroll/payslip/2025-09-01">View payslip</a>.</p>\n<p>Regards,<br>Payroll</p>\n',explain:['Internal payroll address','https link']},
    {id:'e10',level:'Expert',from:'Google <noreply@googlesecurity-help.com>',subject:'Unusual sign-in blocked',received:'2025-09-10 21:51',phish:true,background: 'No background on Expert questions',body:'\n<p>Hi there,</p>\n<p>We blocked an unusual sign-in to your Google account and applied a temporary hold. To review the activity and re-enable services please visit the account security console linked below. This will allow you to review devices, revoke sessions and run a quick security scan.</p>\n<p>Review activity: <a href="#" data-href="http://accounts.google.com.security-check.help">Review activity</a>. Genuine Google security emails will route to the accounts.google.com domain — if the host in the link looks different, do not enter credentials.</p>\n<p>Regards,<br>Google Security</p>\n',explain:['Looks like a Google link but the true host ends with security-check.help','Insecure http://']}
  ]
};

/* --- state --- */
const ROUND_SIZE = 10;
const SCORE_WRONG = -50;
// Score for correct answers varies by difficulty: Beginner=100, Intermediate=150, Expert=200
function scoreForCorrect(lvl){
  if(typeof lvl === 'string'){
    if(lvl === 'Beginner') return 100;
    if(lvl === 'Intermediate') return 150;
    if(lvl === 'Expert') return 200;
  }
  return 100;
}

let player=''; let highScore=0; let level='Beginner'; let deck=[]; let idx=0; let score=0, correct=0, wrong=0; let answers=[];

/* --- helpers --- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function shuffle(arr){ return arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function pickRound(){ const pool = (DATA[level]||[]); return shuffle(pool).slice(0,ROUND_SIZE); }
function updateProgress(){ const pct = Math.round(((idx+1)/ROUND_SIZE)*100); const bar = $('#bar'); if(bar) bar.style.width = pct+'%'; $('#roundPos').textContent = String(idx+1); }
function getHost(url){ try{return new URL(url).host;}catch{return '';} }
function looksPhishyLink(a){ try{ const shown=(a.textContent||'').replace(/^https?:\/\//,'').split('/')[0]; const real=getHost(a.dataset.href||''); return shown && real && shown.toLowerCase()!==real.toLowerCase(); }catch{return false;} }

/* --- highscore --- */
function buildHighTable(){ const tb = $('#scoreTable tbody'); if(!tb) return; tb.innerHTML=''; const rows=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k&&k.startsWith('phishbait_highscore_')) rows.push({name:k.replace('phishbait_highscore_',''),score:parseInt(localStorage.getItem(k)||'0',10)||0}); } rows.sort((a,b)=>b.score-a.score); if(rows.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td>—</td><td>No scores yet</td><td>—</td>'; tb.appendChild(tr); return; } rows.slice(0,10).forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.score}</td>`; tb.appendChild(tr); }); }

function saveHigh(){ if(!player) return; const k='phishbait_highscore_'+player; const old = parseInt(localStorage.getItem(k)||'0',10); if(score>old){ localStorage.setItem(k,String(score)); highScore=score; renderHUD(); buildHighTable(); } }

/* --- render --- */
function renderHUD(){ $('#hudPlayer').textContent = player||'—'; $('#hudScore').textContent = String(score); $('#hudCorrect').textContent = String(correct); $('#hudWrong').textContent = String(wrong); $('#playerInfo').textContent = `Player: ${player||'—'}`; $('#highScore').textContent = String(highScore); }

function clearHighlights(){
  const sender = document.getElementById('emailFrom'); if(sender) sender.style.outline='none';
  $$('#emailBody a').forEach(a=>a.style.outline='none');
}

function renderHistory(){
  const el = $('#history'); if(!el) return; el.innerHTML='';
  deck.forEach((it,i)=>{
    const ans = answers[i];
    const div = document.createElement('div'); div.className='hist-item';
    const dot = document.createElement('div'); dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%'; dot.style.background = ans? (ans.correct? 'var(--good)' : 'var(--bad)') : 'transparent';
    const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:700">${i+1}. ${it.subject}</div><div style="font-size:12px;color:#c9c9c9">${it.from}</div>`;
    div.appendChild(dot); div.appendChild(txt);
    div.addEventListener('click', ()=>{ idx = i; renderEmail(); });
    el.appendChild(div);
  });
}

/* --- render an email --- */
function renderEmail(){
  const item = deck[idx]; if(!item) return;
  $('#emailFrom').textContent = item.from;
  $('#emailSubjectTop').textContent = item.subject;
  $('#emailSubject').textContent = item.subject;
  $('#emailMetaLine').innerHTML = `From <strong>${item.from}</strong> • To <strong>${player||'you'}</strong> • <span>${item.received}</span>`;
  $('#emailReceived').textContent = item.received;
  $('#emailLevel').textContent = item.level || item.level || '—';
  const av = $('#fromAvatar'); if(av){ const m = (item.from.match(/^(.*?)\s*</)||[])[1] || item.from; av.textContent = m.split(/\s+/).map(s=>s[0]||'').join('').slice(0,2).toUpperCase(); }
  if(item.background){
    $('#emailBackground').style.display='block';
    $('#emailBackgroundText').textContent = item.background;
  } else {
    $('#emailBackground').style.display='none';
  }
  $('#emailBody').innerHTML = item.body;
  clearHighlights();
  $('#explainBox').hidden = true; $('#explainCorrectList').innerHTML = ''; $('#explainPhishList').innerHTML = '';
  const rb = $('#resultBanner'); if(rb){ rb.style.display = 'none'; rb.textContent = ''; }
  $('#btnPrev').disabled = idx===0;
  const answered = (answers[idx] && (answers[idx].choice==='PHISH' || answers[idx].choice==='SAFE'));
  $('#btnNext').disabled = !answered;
  updateProgress();
  $$('#emailBody a').forEach(a=>{ a.addEventListener('click', e=>e.preventDefault()); a.addEventListener('mouseenter', e=>{ showTip(a.dataset.href||'Unknown', e.clientX, e.clientY); }); a.addEventListener('mousemove', e=>{ showTip(a.dataset.href||'Unknown', e.clientX, e.clientY); }); a.addEventListener('mouseleave', hideTip); });
}

/* --- plain-language explanation helpers --- */
function addSimple(listEl, text){ const li=document.createElement('li'); li.textContent = text; listEl.appendChild(li); }

function humanExplain(item, ans){
  // ans: { choice, correct }
  const correctList = $('#explainCorrectList'); const phishList = $('#explainPhishList');
  // Use provided item.explain entries as base but expand into user-friendly sentences
  (Array.isArray(item.explain)?item.explain:[]).forEach(e=>{
    // make slightly more descriptive for non-technical users
    if(/domain|sender|address/i.test(e)) addSimple(phishList, e + ' — this means the email came from an address that looks unusual or does not match who it claims to be.');
    else if(/link|portal|url|subdomain|host/i.test(e)) addSimple(phishList, e + ' — check the link carefully: it might look like a familiar site but actually goes somewhere else.');
       else addSimple(phishList, e);
  });

  // Common automated checks we run and explain clearly
  $$('#emailBody a').forEach(a=>{
    const textHost = (a.textContent||'').replace(/^https?:\/\//,'').split('/')[0];
    const realHost = getHost(a.dataset.href||'');
    if(textHost && realHost && textHost.toLowerCase()!==realHost.toLowerCase()){
      addSimple(phishList, `The link text says "${textHost}" but the real destination is "${realHost}". Scammers try to hide the real address like this.`);
      a.style.outline = '2px solid var(--bad)';
    }
    if(/http:\/\//i.test(a.dataset.href||'')){
      addSimple(phishList, 'The link goes to a site that starts with http:// and not https:// — that means data sent there may not be encrypted. Avoid entering passwords or payment details on such links.');
      a.style.outline = '2px solid var(--bad)';
    }
    // highlight odd-looking TLDs
    const oddTLD = realHost.split('.').pop();
    if(/^(cc|gq|cf|tk)$/.test(oddTLD)){
      addSimple(phishList, `The website uses an uncommon domain ending (.${oddTLD}) which is often used by scammers because registrations are cheap.`);
      a.style.outline = '2px solid var(--bad)';
    }
  });

  // Sender checks
  const sender = (item.from||'').toLowerCase();
  if(/m1crosoft|microsoft/i.test(sender) && /m1crosoft/.test(sender)){
    addSimple(phishList, 'The sender name looks like Microsoft but the email address uses a misspelling (e.g. an "1" instead of an "i"), which is a trick attackers use.');
  }
  if(/no-reply|no_reply/i.test(sender)) addSimple(phishList, 'Automated sender addresses (no-reply) are common, but check the actual domain after the @ to be sure it belongs to the company.');

  // Now explain why the user's selection was correct/incorrect in plain language
  if(ans.correct){
    addSimple(correctList, `Your answer (${ans.choice}) is correct because the signs above point to the expected behaviour.`);
    addSimple(correctList, 'It was marked as safe as the links go to a safe domain. Phising emails promote a rushed experience .');
      } else {
    addSimple(correctList, `Your answer (${ans.choice}) was not correct. Here is why the other choice is the right one:`);
    if(ans.choice==='PHISH'){
      addSimple(correctList, 'Although it looked suspicious, the sender and links match our internal/official systems and there is no request for credentials/payments. Over time you will learn to spot the small differences.');
    } else {
      addSimple(correctList, 'Although it looked legitimate, the email contains tricks such as mismatched link destinations, unusual domain names, or requests for passwords/payments which are red flags.');
    }
  }
}

/* --- explanations & highlights --- */
function showExplanations(item){
  const ans = answers[idx];
  if(!ans) return;
  $('#explainCorrectList').innerHTML=''; $('#explainPhishList').innerHTML='';
  humanExplain(item, ans);
  $('#explainBox').hidden = false;
  

  // Show only the relevant explanation panel
  const isPhish = !!item.phish;
  if($('#explainCorrectHeading') && $('#explainCorrectList') && $('#explainPhishHeading') && $('#explainPhishList')){
    if(isPhish){
      $('#explainPhishHeading').style.display = '';
      $('#explainPhishList').style.display = '';
      $('#explainCorrectHeading').style.display = 'none';
      $('#explainCorrectList').style.display = 'none';
    } else {
      $('#explainCorrectHeading').style.display = '';
      $('#explainCorrectList').style.display = '';
      $('#explainPhishHeading').style.display = 'none';
      $('#explainPhishList').style.display = 'none';
    }
  }

clearHighlights();
  const senderEl = $('#emailFrom');
  const links = $$('#emailBody a');
  if(ans.correct){ /* No green outline on correct answers */ }
else { if(senderEl) senderEl.style.outline = '2px solid var(--bad)'; }
}

/* --- answer handling --- */
function answer(choice){
  const item = deck[idx]; if(!item) return;
  if(answers[idx]){ showExplanations(item); return; }
  const correctAns = (choice === 'PHISH') === !!item.phish;
  if(correctAns){ score += scoreForCorrect(level); correct++; }
  else { score += SCORE_WRONG; wrong++; }
  answers[idx] = { choice: choice, correct: correctAns };
  renderHUD();
  const banner = $('#resultBanner');
  if(banner){ banner.style.display = 'block'; banner.className = ''; if(correctAns){ banner.classList.add('outline-good'); banner.style.background = 'rgba(34,197,94,0.12)'; banner.textContent = 'CORRECT — Good job!'; } else { banner.classList.add('outline-bad'); banner.style.background = 'rgba(255,59,48,0.08)'; banner.textContent = 'INCORRECT — Review below.'; } }
  showExplanations(item);
  $('#btnNext').disabled = idx === ROUND_SIZE-1;
  renderHistory();
  if(answers.filter(Boolean).length === ROUND_SIZE){ $('#btnNext').disabled = false; }
}

/* --- navigation --- */
function prev(){ if(idx>0){ idx--; renderEmail(); } }
function next(){
  if(idx<ROUND_SIZE-1){ idx++; renderEmail(); }
  else {
    if(answers.filter(Boolean).length === ROUND_SIZE){ endRound(); saveHigh(); showCompletion(); }
  }
}

/* --- end round --- */
function endRound(){
  const h = $('#history'); if(!h) return;
  const el = document.createElement('div'); el.className = 'hist-item';
  el.innerHTML = '<strong>Final: ' + score + ' pts — ' + correct + '/' + ROUND_SIZE + '</strong><div style="font-size:12px;color:#c9c9c9">Level ' + level + '</div>';
  h.appendChild(el);
}

/* --- completion UI --- */
function showCompletion(){
  $('#completionSummary').textContent = `Round complete — Score: ${score} pts — ${correct}/${ROUND_SIZE} correct (Level: ${level})`;
  // Outcome message
  const outcome = (correct === ROUND_SIZE) ? '🎉 Well done — perfect score!' : 'Please try again — review the explanations and give it another go.';
  const panel = document.getElementById('completionPanel');
  let outcomeEl = document.getElementById('completionOutcome');
  if(!outcomeEl){
    outcomeEl = document.createElement('div');
    outcomeEl.id = 'completionOutcome';
    outcomeEl.style.margin = '6px 0 12px 0';
    outcomeEl.style.fontWeight = '600';
    panel.insertBefore(outcomeEl, panel.querySelector('div').nextSibling);
  }
  outcomeEl.textContent = outcome;
  document.getElementById('completionPanel').style.display = 'block';
  // hide main game actions to avoid confusion
  $('#gamePanel').style.display = 'none';
}
function tryAgainSame(){
  // start a fresh round at same level
  deck = pickRound(); idx = 0; score = 0; correct = 0; wrong = 0; answers = [];
  renderHUD(); renderHistory(); renderEmail(); document.getElementById('completionPanel').style.display = 'none'; $('#gamePanel').style.display = 'block';
}
function tryDifferent(){
  // return user to title to pick level
  document.getElementById('completionPanel').style.display = 'none'; $('#gamePanel').style.display = 'none'; $('#titleScreen').style.display = 'block'; $('#startBtn').disabled = false;
}
function backToTitle(){
  document.getElementById('completionPanel').style.display = 'none'; $('#gamePanel').style.display = 'none'; $('#titleScreen').style.display = 'block'; $('#startBtn').disabled = false;
}

/* --- start & reset --- */
function startGame(){
  const n = $('#nameInput').value.trim(); if(!n){ alert('Enter your name'); return; }
  player = n; level = $('#levelSelect').value || 'Beginner'; highScore = parseInt(localStorage.getItem('phishbait_highscore_'+player)||'0',10) || 0;
  deck = pickRound(); idx = 0; score = 0; correct = 0; wrong = 0; answers = [];
  renderHUD(); renderHistory(); renderEmail(); buildHighTable();
  $('#titleScreen').style.display = 'none'; $('#gamePanel').style.display = 'block'; $('#startBtn').disabled = true;
}

function resetGame(){ deck = pickRound(); idx = 0; score = 0; correct = 0; wrong = 0; answers = []; renderHUD(); renderHistory(); renderEmail(); $('#startBtn').disabled = true; }

/* --- tooltip --- */
const tip = document.getElementById('tooltip');
function showTip(text,x,y){ if(!tip) return; tip.textContent = text; tip.style.left = (x+12)+'px'; tip.style.top = (y+12)+'px'; tip.classList.add('show'); tip.setAttribute('aria-hidden','false'); }
function hideTip(){ if(!tip) return; tip.classList.remove('show'); tip.setAttribute('aria-hidden','true'); }

/* --- events --- */
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('btnPhish').addEventListener('click', function(){ answer('PHISH'); });
document.getElementById('btnSafe').addEventListener('click', function(){ answer('SAFE'); });
document.getElementById('btnPrev').addEventListener('click', prev);
document.getElementById('btnNext').addEventListener('click', next);
document.getElementById('btnReset').addEventListener('click', resetGame);
document.getElementById('btnTrySame').addEventListener('click', tryAgainSame);
document.getElementById('btnTryDifferent').addEventListener('click', tryDifferent);
document.getElementById('btnBackToTitle').addEventListener('click', backToTitle);

/* --- init --- */
buildHighTable();
</script>

<!-- Supabase highscores injection -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
window.SUPABASE_URL = "https://ynrawnlcrialbujsihlc.supabase.co";
window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlucmF3bmxjcmlhbGJ1anNpaGxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2OTI5MzgsImV4cCI6MjA3NTI2ODkzOH0.IRYBALz9D13CHkzrFTHbAm3e-rlzpVzZVdVuto3oRwQ";
const SB = window.supabase ? window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY) : null;

/** Build the leaderboard table (#scoreTable) */
async function buildHighTable() {
  const tb = document.querySelector('#scoreTable tbody');
  if (!tb) return;
  tb.innerHTML = '';

  if (SB) {
    try {
      // ✅ now also selects "difficulty"
      const { data, error } = await SB
        .from('highscores')
        .select('player,score,difficulty')
        .order('score', { ascending: false })
        .limit(50);

      if (error) throw error;
      const rows = data || [];
      if (rows.length === 0) {
        tb.innerHTML = '<tr><td>—</td><td>No scores yet</td><td>—</td><td>—</td></tr>';
        return;
      }
      rows.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.player}</td>
          <td>${r.score}</td>
          <td>${r.difficulty || '—'}</td>
        `;
        tb.appendChild(tr);
      });
      return;
    } catch (e) {
      console.warn('Supabase leaderboard failed, using localStorage', e);
    }
  }

  // 🔁 Fallback to localStorage if Supabase is unavailable
  const rows = [];
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k && k.startsWith('phishbait_highscore_') && !k.endsWith('_difficulty')) {
      const playerName = k.replace('phishbait_highscore_', '');
      rows.push({
        player: playerName,
        score: parseInt(localStorage.getItem(k) || '0', 50) || 0,
        difficulty: localStorage.getItem(k + '_difficulty') || '—',
      });
    }
  }
  rows.sort((a, b) => b.score - a.score);
  if (rows.length === 0) {
    tb.innerHTML = '<tr><td>—</td><td>No scores yet</td><td>—</td><td>—</td></tr>';
    return;
  }
  rows.slice(0, 50).forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${r.player}</td>
      <td>${r.score}</td>
      <td>${r.difficulty}</td>
    `;
    tb.appendChild(tr);
  });
}

/** Get a single player's best score (used when starting a game) */
async function fetchPlayerHigh(name){
  if (SB) {
    try {
      const { data, error } = await SB
        .from('highscores')
        .select('score')
        .eq('player', name)
        .order('score', { ascending:false })
        .limit(1)
        .maybeSingle();
      if (error) throw error;
      return (data && data.score) || 0;
    } catch (e) { console.warn('Supabase fetch high failed, using localStorage', e); }
  }
  return parseInt(localStorage.getItem('phishbait_highscore_'+name)||'0',50) || 0;
}

/** Save the current score (and difficulty) */
async function saveHigh(){
  try { if (typeof player === 'undefined' || typeof score === 'undefined') return; } catch(e) { return; }

  if (SB) {
    try {
      // ✅ store difficulty as well
      const { error } = await SB.from('highscores').insert({ player, score, difficulty: (typeof level !== 'undefined' ? level : null) });
      if (error) console.warn('Supabase insert error', error);
      try { if (typeof renderHUD==='function') renderHUD(); } catch(_e){}
      try { buildHighTable(); } catch(_e){}
      return;
    } catch (e) {
      console.warn('Supabase save failed, falling back to local', e);
    }
  }

  // 🔁 Fallback local save (also persist difficulty)
  const k = 'phishbait_highscore_' + player;
  const old = parseInt(localStorage.getItem(k) || '0', 50);
  if (score > old) {
    localStorage.setItem(k, String(score));
    try { localStorage.setItem(k + '_difficulty', (typeof level !== 'undefined' ? level : '—')); } catch(_e){}
    try { if (typeof renderHUD==='function') renderHUD(); } catch(_e){}
    try { buildHighTable(); } catch(_e){}
  }
}

// Ensure table is built on load
document.addEventListener('DOMContentLoaded', ()=>{ try{ buildHighTable(); }catch(e){} });
</script>


</body>
</html>
